# ============================================================
# Peptide Optimization Workers - 3 实例独占 P-core + 共享 E-core
# ============================================================
# Intel Core Ultra 9 285K 核心布局:
#   P-core: CPU 0-7   (8核, 5.5-5.7 GHz, 高性能, 独立 L2)
#   E-core: CPU 8-23  (16核, 4.7 GHz, 能效核, 共享 L2)
#
# 分配策略:
#   Worker 1: P-core 0,1,2 (独占) + E-core 8-23 (共享)
#   Worker 2: P-core 3,4,5 (独占) + E-core 8-23 (共享)
#   Worker 3: P-core 6,7   (独占) + E-core 8-23 (共享)
#
# 启动方式:
#   全部启动:     docker compose up -d
#   启动1个:      docker compose up -d peptide-opt-1
#   启动2个:      docker compose up -d peptide-opt-1 peptide-opt-2
# ============================================================

x-peptide-worker: &peptide-worker
  build:
    context: ..
    dockerfile: docker/Dockerfile
  image: peptide-opt:latest
  restart: on-failure:3
  env_file:
    - ../.env
  extra_hosts:
    - "host.docker.internal:host-gateway"
  environment: &peptide-env
    # --- 数据库连接 ---
    - DB_HOST=host.docker.internal
    - DB_PORT=5432
    - DB_USER=${DB_USER:-admin}
    - DB_PASSWORD=${DB_PASSWORD:-secret}
    - DB_NAME=${DB_NAME:-mydatabase}
    # --- SeaweedFS 连接 ---
    - SEAWEED_FILER_ENDPOINT=http://host.docker.internal:8888
    - SEAWEED_BUCKET=${SEAWEED_BUCKET:-astramolecula}
    # --- 应用配置 ---
    - LOG_LEVEL=${LOG_LEVEL:-INFO}
    - POLL_INTERVAL=${POLL_INTERVAL:-30}
    - NVIDIA_VISIBLE_DEVICES=all
  volumes:
    - peptide-data:/app/data
    - peptide-logs:/app/logs
  networks:
    - peptide-network
  healthcheck:
    test: ["CMD-SHELL", "curl -f http://localhost:${PORT:-8000}/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 10s

services:
  # --- Worker 1: P-core 0,1,2 (独占) + E-core 8-23 (共享) ---
  peptide-opt-1:
    <<: *peptide-worker
    container_name: peptide-opt-1
    cpuset: '0-2,8-23'
    deploy:
      resources:
        limits:
          cpus: '4'
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # --- Worker 2: P-core 3,4,5 (独占) + E-core 8-23 (共享) ---
  peptide-opt-2:
    <<: *peptide-worker
    container_name: peptide-opt-2
    cpuset: '3-5,8-23'
    deploy:
      resources:
        limits:
          cpus: '4'
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # --- Worker 3: P-core 6,7 (独占) + E-core 8-23 (共享) ---
  peptide-opt-3:
    <<: *peptide-worker
    container_name: peptide-opt-3
    cpuset: '6-7,8-23'
    deploy:
      resources:
        limits:
          cpus: '4'
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

volumes:
  peptide-data:
  peptide-logs:

networks:
  peptide-network:
    driver: bridge